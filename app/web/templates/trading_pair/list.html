{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block head %}
<style>
.trading-pair-table th {
    position: sticky;
    top: 0;
    background: white;
    z-index: 10;
}
.status-badge {
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
}
.status-enabled {
    background-color: #d4edda;
    color: #155724;
}
.status-disabled {
    background-color: #f8d7da;
    color: #721c24;
}
.filter-card {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
}
.action-buttons .btn {
    margin-right: 5px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 页面标题和操作按钮 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="fas fa-exchange-alt me-2"></i>{{ title }}
        </h1>
        <div>
            <a href="{{ url_for('create_trading_pair_page') }}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>创建交易对
            </a>
            <button type="button" class="btn btn-outline-secondary" id="refreshBtn">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </div>

    <!-- 筛选卡片 -->
    <div class="card filter-card">
        <div class="card-body">
            <form id="filterForm" class="row g-3">
                <div class="col-md-3">
                    <label for="exchangeFilter" class="form-label">交易所</label>
                    <select class="form-select" id="exchangeFilter" name="exchange">
                        <option value="">全部交易所</option>
                        {% for ex in exchanges %}
                        <option value="{{ ex }}" {% if ex == selected_exchange %}selected{% endif %}>
                            {{ ex|upper }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label for="accountTypeFilter" class="form-label">账户类型</label>
                    <select class="form-select" id="accountTypeFilter" name="account_type">
                        <option value="">全部类型</option>
                        {% for type in account_types %}
                        <option value="{{ type }}" {% if type == selected_account_type %}selected{% endif %}>
                            {{ type|upper }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label class="form-label">状态</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="enabledOnly" 
                               name="enabled_only" {% if enabled_only %}checked{% endif %}>
                        <label class="form-check-label" for="enabledOnly">
                            仅显示启用的
                        </label>
                    </div>
                </div>
                
                <div class="col-md-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="fas fa-filter me-2"></i>筛选
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="resetFilter">
                        重置
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 批量操作工具栏 -->
    <div class="card mb-3">
        <div class="card-body py-2">
            <div class="d-flex justify-content-between align-items-center">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="selectAll">
                    <label class="form-check-label" for="selectAll">
                        全选
                    </label>
                </div>
                <div class="action-buttons">
                    <button type="button" class="btn btn-sm btn-success" id="batchEnableBtn">
                        <i class="fas fa-check-circle me-1"></i>启用选中
                    </button>
                    <button type="button" class="btn btn-sm btn-warning" id="batchDisableBtn">
                        <i class="fas fa-ban me-1"></i>禁用选中
                    </button>
                    <button type="button" class="btn btn-sm btn-danger" id="batchDeleteBtn">
                        <i class="fas fa-trash me-1"></i>删除选中
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 交易对表格 -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover trading-pair-table">
                    <thead>
                        <tr>
                            <th width="40">
                                <input type="checkbox" class="form-check-input" id="selectAllRows">
                            </th>
                            <th>基础符号</th>
                            <th>交易所</th>
                            <th>账户类型</th>
                            <th>交易所符号</th>
                            <th>状态</th>
                            <th>配置</th>
                            <th>创建时间</th>
                            <th width="150">操作</th>
                        </tr>
                    </thead>
                    <tbody id="tradingPairsBody">
                        <!-- 通过JavaScript动态加载 -->
                        <tr id="loadingRow">
                            <td colspan="9" class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                                <p class="mt-2 text-muted">正在加载交易对数据...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- 分页 -->
            <nav aria-label="交易对分页" class="mt-3">
                <ul class="pagination justify-content-center" id="pagination">
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- 删除确认模态框 -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">确认删除</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>确定要删除选中的交易对吗？此操作不可撤销。</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    删除交易对可能会影响正在运行的策略！
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">确认删除</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 全局变量
let currentPage = 1;
let pageSize = 20;
let totalItems = 0;
let selectedPairs = new Set();

// 初始化页面
$(document).ready(function() {
    loadTradingPairs();
    setupEventListeners();
});

// 加载交易对数据
function loadTradingPairs(page = 1) {
    currentPage = page;
    
    const params = new URLSearchParams({
        exchange: $('#exchangeFilter').val() || '',
        account_type: $('#accountTypeFilter').val() || '',
        enabled_only: $('#enabledOnly').is(':checked'),
        page: page,
        page_size: pageSize,
    });
    
    $('#tradingPairsBody').html(`
        <tr id="loadingRow">
            <td colspan="9" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
                <p class="mt-2 text-muted">正在加载交易对数据...</p>
            </td>
        </tr>
    `);
    
    $.ajax({
        url: '/api/trading-pairs?' + params.toString(),
        type: 'GET',
        success: function(response) {
            if (response.success) {
                renderTradingPairs(response.data);
                renderPagination(response.data);
            } else {
                showError('加载失败：' + response.message);
            }
        },
        error: function(xhr) {
            showError('加载失败：' + xhr.responseText);
        }
    });
}

// 渲染交易对表格
function renderTradingPairs(data) {
    const items = data.items;
    totalItems = data.total;
    
    if (items.length === 0) {
        $('#tradingPairsBody').html(`
            <tr>
                <td colspan="9" class="text-center py-5">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <p class="text-muted">暂无交易对数据</p>
                    <a href="{{ url_for('create_trading_pair_page') }}" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>创建第一个交易对
                    </a>
                </td>
            </tr>
        `);
        return;
    }
    
    let html = '';
    items.forEach(function(pair) {
        const isSelected = selectedPairs.has(pair.id);
        const statusClass = pair.is_enabled ? 'status-enabled' : 'status-disabled';
        const statusText = pair.is_enabled ? '启用' : '禁用';
        
        // 格式化配置
        let configText = '-';
        if (pair.config && Object.keys(pair.config).length > 0) {
            configText = Object.entries(pair.config)
                .map(([k, v]) => `${k}: ${v}`)
                .join(', ');
            if (configText.length > 50) {
                configText = configText.substring(0, 50) + '...';
            }
        }
        
        // 格式化时间
        const createTime = pair.created_at ? 
            new Date(pair.created_at).toLocaleString() : '-';
        
        html += `
        <tr data-pair-id="${pair.id}">
            <td>
                <input type="checkbox" class="form-check-input pair-checkbox" 
                       data-pair-id="${pair.id}" ${isSelected ? 'checked' : ''}>
            </td>
            <td>
                <strong>${escapeHtml(pair.base_symbol)}</strong>
                ${pair.description ? `<br><small class="text-muted">${escapeHtml(pair.description)}</small>` : ''}
            </td>
            <td>
                <span class="badge bg-info">${escapeHtml(pair.exchange.toUpperCase())}</span>
            </td>
            <td>
                <span class="badge bg-secondary">${escapeHtml(pair.account_type.toUpperCase())}</span>
            </td>
            <td>
                <code>${escapeHtml(pair.exchange_symbol)}</code>
            </td>
            <td>
                <span class="status-badge ${statusClass}">${statusText}</span>
            </td>
            <td>
                <small>${escapeHtml(configText)}</small>
            </td>
            <td>
                <small class="text-muted">${createTime}</small>
            </td>
            <td>
                <div class="btn-group btn-group-sm" role="group">
                    <a href="/trading-pair/${pair.id}/edit" class="btn btn-outline-primary">
                        <i class="fas fa-edit"></i>
                    </a>
                    <button type="button" class="btn btn-outline-${pair.is_enabled ? 'warning' : 'success'} toggle-btn"
                            data-pair-id="${pair.id}" data-enabled="${pair.is_enabled}">
                        <i class="fas fa-${pair.is_enabled ? 'ban' : 'check'}"></i>
                    </button>
                    <button type="button" class="btn btn-outline-danger delete-btn"
                            data-pair-id="${pair.id}" data-symbol="${pair.base_symbol}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
        `;
    });
    
    $('#tradingPairsBody').html(html);
    updateSelectAllState();
}

// 渲染分页
function renderPagination(data) {
    const totalPages = data.total_pages;
    if (totalPages <= 1) {
        $('#pagination').html('');
        return;
    }
    
    let html = '';
    
    // 上一页
    html += `
    <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" data-page="${currentPage - 1}">
            <i class="fas fa-chevron-left"></i>
        </a>
    </li>
    `;
    
    // 页码
    const maxVisible = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
    let endPage = Math.min(totalPages, startPage + maxVisible - 1);
    
    if (endPage - startPage + 1 < maxVisible) {
        startPage = Math.max(1, endPage - maxVisible + 1);
    }
    
    for (let i = startPage; i <= endPage; i++) {
        html += `
        <li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" data-page="${i}">${i}</a>
        </li>
        `;
    }
    
    // 下一页
    html += `
    <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
        <a class="page-link" href="#" data-page="${currentPage + 1}">
            <i class="fas fa-chevron-right"></i>
        </a>
    </li>
    `;
    
    $('#pagination').html(html);
}

// 设置事件监听器
function setupEventListeners() {
    // 筛选表单
    $('#filterForm').submit(function(e) {
        e.preventDefault();
        loadTradingPairs(1);
    });
    
    // 重置筛选
    $('#resetFilter').click(function() {
        $('#exchangeFilter').val('');
        $('#accountTypeFilter').val('');
        $('#enabledOnly').prop('checked', true);
        loadTradingPairs(1);
    });
    
    // 刷新按钮
    $('#refreshBtn').click(function() {
        loadTradingPairs(currentPage);
    });
    
    // 全选/取消全选
    $('#selectAll, #selectAllRows').change(function() {
        const isChecked = $(this).is(':checked');
        $('.pair-checkbox').prop('checked', isChecked);
        
        if (isChecked) {
            // 获取当前页所有ID
            $('.pair-checkbox').each(function() {
                const pairId = $(this).data('pair-id');
                selectedPairs.add(pairId);
            });
        } else {
            // 清除当前页的选择
            $('.pair-checkbox').each(function() {
                const pairId = $(this).data('pair-id');
                selectedPairs.delete(pairId);
            });
        }
        
        updateSelectedCount();
    });
    
    // 单个选择框
    $(document).on('change', '.pair-checkbox', function() {
        const pairId = $(this).data('pair-id');
        const isChecked = $(this).is(':checked');
        
        if (isChecked) {
            selectedPairs.add(pairId);
        } else {
            selectedPairs.delete(pairId);
        }
        
        updateSelectAllState();
        updateSelectedCount();
    });
    
    // 启用/禁用单个
    $(document).on('click', '.toggle-btn', function() {
        const pairId = $(this).data('pair-id');
        const isEnabled = $(this).data('enabled');
        const action = isEnabled ? '禁用' : '启用';
        
        if (confirm(`确定要${action}这个交易对吗？`)) {
            toggleTradingPair(pairId, !isEnabled);
        }
    });
    
    // 删除单个
    $(document).on('click', '.delete-btn', function() {
        const pairId = $(this).data('pair-id');
        const symbol = $(this).data('symbol');
        
        if (confirm(`确定要删除交易对 ${symbol} 吗？此操作不可撤销。`)) {
            deleteTradingPair(pairId);
        }
    });
    
    // 批量启用
    $('#batchEnableBtn').click(function() {
        if (selectedPairs.size === 0) {
            alert('请先选择交易对');
            return;
        }
        
        if (confirm(`确定要启用选中的 ${selectedPairs.size} 个交易对吗？`)) {
            batchUpdateTradingPairs(Array.from(selectedPairs), true);
        }
    });
    
    // 批量禁用
    $('#batchDisableBtn').click(function() {
        if (selectedPairs.size === 0) {
            alert('请先选择交易对');
            return;
        }
        
        if (confirm(`确定要禁用选中的 ${selectedPairs.size} 个交易对吗？`)) {
            batchUpdateTradingPairs(Array.from(selectedPairs), false);
        }
    });
    
    // 批量删除
    $('#batchDeleteBtn').click(function() {
        if (selectedPairs.size === 0) {
            alert('请先选择交易对');
            return;
        }
        
        $('#deleteModal').modal('show');
    });
    
    // 确认批量删除
    $('#confirmDelete').click(function() {
        const pairIds = Array.from(selectedPairs);
        batchDeleteTradingPairs(pairIds);
        $('#deleteModal').modal('hide');
    });
    
    // 分页点击
    $(document).on('click', '.page-link', function(e) {
        e.preventDefault();
        const page = $(this).data('page');
        if (page) {
            loadTradingPairs(page);
        }
    });
}

// 更新全选状态
function updateSelectAllState() {
    const currentPageCount = $('.pair-checkbox').length;
    const currentPageChecked = $('.pair-checkbox:checked').length;
    
    const allChecked = currentPageCount > 0 && currentPageCount === currentPageChecked;
    $('#selectAll').prop('checked', allChecked);
    $('#selectAllRows').prop('checked', allChecked);
}

// 更新选中计数
function updateSelectedCount() {
    const count = selectedPairs.size;
    if (count > 0) {
        $('#batchDeleteBtn').text(`删除选中(${count})`);
        $('#batchEnableBtn').text(`启用选中(${count})`);
        $('#batchDisableBtn').text(`禁用选中(${count})`);
    } else {
        $('#batchDeleteBtn').text('删除选中');
        $('#batchEnableBtn').text('启用选中');
        $('#batchDisableBtn').text('禁用选中');
    }
}

// 启用/禁用交易对
function toggleTradingPair(pairId, enable) {
    const action = enable ? '启用' : '禁用';
    
    $.ajax({
        url: `/api/trading-pairs/${pairId}`,
        type: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify({
            is_enabled: enable,
            // 其他字段保持不变（实际应该获取当前值）
        }),
        success: function(response) {
            if (response.success) {
                showSuccess(`${action}成功`);
                loadTradingPairs(currentPage);
            } else {
                showError(`${action}失败：` + response.message);
            }
        },
        error: function(xhr) {
            showError(`${action}失败：` + xhr.responseText);
        }
    });
}

// 删除交易对
function deleteTradingPair(pairId) {
    $.ajax({
        url: `/api/trading-pairs/${pairId}`,
        type: 'DELETE',
        success: function(response) {
            if (response.success) {
                showSuccess('删除成功');
                selectedPairs.delete(pairId);
                loadTradingPairs(currentPage);
            } else {
                showError('删除失败：' + response.message);
            }
        },
        error: function(xhr) {
            showError('删除失败：' + xhr.responseText);
        }
    });
}

// 批量更新交易对状态
function batchUpdateTradingPairs(pairIds, enable) {
    const action = enable ? '启用' : '禁用';
    
    $.ajax({
        url: '/api/trading-pairs/batch-enable',
        type: 'POST',
        contentType: 'application/x-www-form-urlencoded',
        data: {
            pair_ids: pairIds,
            enable: enable,
        },
        traditional: true,
        success: function(response) {
            if (response.success) {
                showSuccess(`${action}成功，共更新 ${response.data.updated_count} 个交易对`);
                selectedPairs.clear();
                loadTradingPairs(currentPage);
            } else {
                showError(`${action}失败：` + response.message);
            }
        },
        error: function(xhr) {
            showError(`${action}失败：` + xhr.responseText);
        }
    });
}

// 批量删除交易对
function batchDeleteTradingPairs(pairIds) {
    // 这里可以逐个删除或实现批量删除接口
    let successCount = 0;
    let failCount = 0;
    
    const deletePromises = pairIds.map(pairId => {
        return $.ajax({
            url: `/api/trading-pairs/${pairId}`,
            type: 'DELETE',
        }).then(
            () => successCount++,
            () => failCount++
        );
    });
    
    Promise.allSettled(deletePromises).then(() => {
        if (failCount === 0) {
            showSuccess(`成功删除 ${successCount} 个交易对`);
        } else {
            showWarning(`删除完成：成功 ${successCount} 个，失败 ${failCount} 个`);
        }
        
        selectedPairs.clear();
        loadTradingPairs(currentPage);
    });
}

// 工具函数：显示成功消息
function showSuccess(message) {
    // 使用Bootstrap的Toast或Alert
    alert('成功：' + message); // 简化版，实际应该用更优雅的方式
}

// 工具函数：显示错误消息
function showError(message) {
    alert('错误：' + message);
}

// 工具函数：显示警告
function showWarning(message) {
    alert('警告：' + message);
}

// 工具函数：HTML转义
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}